<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JavaScript Test Runner</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { text-align: center; }
        .summary { margin-bottom: 20px; padding: 10px; background-color: #f0f0f0; border: 1px solid #ddd; }
        .summary p { margin: 5px 0; }
        #resultsList { list-style-type: none; padding: 0; }
        #resultsList li {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .pass { background-color: #d4edda; color: #155724; border-left: 5px solid #28a745; }
        .fail { background-color: #f8d7da; color: #721c24; border-left: 5px solid #dc3545; }
        .fail pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            background-color: #f1f1f1;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-top: 8px;
            font-size: 0.9em;
            color: #333;
        }
    </style>
</head>
<body>
    <h1>JavaScript Test Results</h1>

    <div class="summary">
        <p>Total Tests: <span id="totalTests">0</span></p>
        <p>Passed: <span id="testsPassed">0</span></p>
        <p>Failed: <span id="testsFailed">0</span></p>
    </div>

    <ol id="resultsList"></ol>

    <!-- Copied JavaScript from index.html -->
    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è GitHub
        const githubConfig = {
            // –≠—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
            owner: '', // –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è GitHub
            repo: '', // –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
            branch: 'main', // –í–µ—Ç–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            token: '', // –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ GitHub
            imagesPath: 'images/' // –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
        };

        let uploadedImages = new Map();
        let processedContent = '';
        let imageUrlMap = new Map(); // –ú–∞–ø–ø–∏–Ω–≥ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–∞ –ø—É–±–ª–∏—á–Ω—ã–µ URL
        
        let currentArticleIdForManagement = null; // Store article ID for management modal


        // –°–∏–º—É–ª—è—Ü–∏—è CDN URL –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–≤ —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —ç—Ç–æ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞—Å—Ç–æ—è—â–∏–π CDN)
        function generatePublicImageUrl(filename, dataUrl) {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const imageId = 'img_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            // –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—Ä–æ—Å –∫ –≤–∞—à–µ–º—É CDN/—Å–µ—Ä–≤–µ—Ä—É
            // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º imgbb.com API –∏–ª–∏ –ø–æ–¥–æ–±–Ω—ã–π —Å–µ—Ä–≤–∏—Å

            // –í—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º data URL, –Ω–æ —Å –º–∞—Ä–∫–µ—Ä–æ–º –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –∑–∞–º–µ–Ω—ã
            const publicUrl = `https://cdn.publikator.demo/${imageId}/${filename}`;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞–ø–ø–∏–Ω–≥ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
            imageUrlMap.set(filename, {
                publicUrl: publicUrl,
                dataUrl: dataUrl,
                filename: filename
            });

            return publicUrl;
        }

        // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ data URL –≤ blob URL –¥–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        function dataUrlToBlobUrl(dataUrl) {
            const arr = dataUrl.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while(n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            const blob = new Blob([u8arr], {type: mime});
            return URL.createObjectURL(blob);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞
        if (document.getElementById('textFile')) { // Check if element exists before adding listener
            document.getElementById('textFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('textEditor').value = e.target.result;
                    };
                    reader.readAsText(file, 'utf-8');
                }
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        if (document.getElementById('imageFiles')) {
            document.getElementById('imageFiles').addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                // const imagesList = document.getElementById('imagesList'); // Not needed here for logic

                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        uploadedImages.set(file.name, e.target.result);
                        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π URL –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        generatePublicImageUrl(file.name, e.target.result);
                        if (typeof updateImagesList === "function") updateImagesList(); // Call if exists
                    };
                    reader.readAsDataURL(file);
                });
            });
        }

        function updateImagesList() {
            const imagesList = document.getElementById('imagesList');
            if (!imagesList) return; // Guard if not in testing DOM
            imagesList.innerHTML = '';

            if (uploadedImages.size > 0) {
                const title = document.createElement('div');
                title.innerHTML = '<strong>–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</strong>';
                imagesList.appendChild(title);

                uploadedImages.forEach((dataUrl, filename) => {
                    const item = document.createElement('div');
                    item.className = 'image-item';
                    item.innerHTML = `
                        <img src="${dataUrl}" alt="${filename}" />
                        <span>${filename}</span>
                    `;
                    imagesList.appendChild(item);
                });
            }
        }

        function generatePreview() {
            const textEditor = document.getElementById('textEditor');
            const previewContent = document.getElementById('previewContent');
            if (!textEditor || !previewContent) return; // Guard

            const text = textEditor.value;
            
            if (!text.trim()) {
                previewContent.innerHTML = '<p style="color: #999;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç</p>';
                return;
            }

            let processedText = text;

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π [IMG:]
            const imageRegex = /\[IMG:([^\]]+)\]\s*([^\\n]*)/g;
            processedText = processedText.replace(imageRegex, (match, filename, caption) => {
                const imageData = uploadedImages.get(filename);
                if (imageData) {
                    const captionHtml = caption ? `<figcaption>${caption.trim()}</figcaption>` : '';
                    return `<figure><img src="${imageData}" alt="${caption}" />${captionHtml}</figure>`;
                } else {
                    return `<div style="background: #ffebee; color: #c62828; padding: 10px; border-radius: 5px; margin: 10px 0;">‚ö†Ô∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ "${filename}" –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>`;
                }
            });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–Ω–ª–∞–π–Ω –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π [URL:]
            const urlRegex = /\[URL:([^\]]+)\]\s*([^\\n]*)/g;
            processedText = processedText.replace(urlRegex, (match, imageUrl, caption) => {
                const captionHtml = caption ? `<figcaption>${caption.trim()}</figcaption>` : '';
                const errorDiv = `<div style="display: none; background: #ffebee; color: #c62828; padding: 10px; border-radius: 5px; margin: 10px 0;">‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${imageUrl}</div>`;
                return `<figure><img src="${imageUrl}" alt="${caption}" onload="this.style.opacity='1'" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'" style="opacity: 0.5; transition: opacity 0.3s;" />${errorDiv}${captionHtml}</figure>`;
            });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–±–∑–∞—Ü–µ–≤
            processedText = processedText.split('\\n\\n').map(paragraph => {
                if (paragraph.trim() && !paragraph.includes('<figure') && !paragraph.includes('<div')) { 
                    return `<p>${paragraph.trim().replace(/\\n/g, '<br>')}</p>`;
                }
                return paragraph; 
            }).join(''); 

            previewContent.innerHTML = processedText;
            processedContent = processedText; 
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ GitHub
        function setupGitHub() {
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = '9999';

            const modalContent = document.createElement('div');
            modalContent.style.backgroundColor = 'white';
            modalContent.style.padding = '30px';
            modalContent.style.borderRadius = '10px';
            modalContent.style.width = '500px';
            modalContent.style.maxWidth = '90%';
            modalContent.style.maxHeight = '90%';
            modalContent.style.overflowY = 'auto';

            modalContent.innerHTML = \`
                <h2 style="margin-top: 0; color: #4facfe;">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å GitHub</h2>
                <p>–î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ —á–µ—Ä–µ–∑ GitHub, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–ª—è:</p>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è GitHub:</label>
                    <input type="text" id="github-owner" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" 
                        value="\${githubConfig.owner}" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, username">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:</label>
                    <input type="text" id="github-repo" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" 
                        value="\${githubConfig.repo}" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, my-blog-images">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">–í–µ—Ç–∫–∞:</label>
                    <input type="text" id="github-branch" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" 
                        value="\${githubConfig.branch}" placeholder="main">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞:</label>
                    <input type="password" id="github-token" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" 
                        value="\${githubConfig.token}" placeholder="ghp_xxxxxxxxxxxx">
                    <p style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        <a href="https://github.com/settings/tokens" target="_blank" style="color: #4facfe;">–°–æ–∑–¥–∞—Ç—å —Ç–æ–∫–µ–Ω</a> 
                        —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é (repo).
                    </p>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">–ü—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏:</label>
                    <input type="text" id="github-images-path" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" 
                        value="\${githubConfig.imagesPath}" placeholder="e.g., images/articles/">
                    <p style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (e.g., images/ –∏–ª–∏ my-docs/assets/). <strong>–í–∞–∂–Ω–æ: –ø—É—Ç—å –¥–æ–ª–∂–µ–Ω –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –Ω–∞ /</strong>
                    </p>
                </div>
                <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                    <button id="github-cancel" style="padding: 10px 15px; margin-right: 10px; border: none; border-radius: 5px; 
                        background-color: #f1f1f1; cursor: pointer;">–û—Ç–º–µ–Ω–∞</button>
                    <button id="github-save" style="padding: 10px 15px; border: none; border-radius: 5px; 
                        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; cursor: pointer;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            \`;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            document.getElementById('github-cancel').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            document.getElementById('github-save').addEventListener('click', () => {
                githubConfig.owner = document.getElementById('github-owner').value.trim();
                githubConfig.repo = document.getElementById('github-repo').value.trim();
                githubConfig.branch = document.getElementById('github-branch').value.trim() || 'main';
                githubConfig.token = document.getElementById('github-token').value.trim();
                githubConfig.imagesPath = document.getElementById('github-images-path').value.trim();

                if (githubConfig.imagesPath && githubConfig.imagesPath !== '/' && !githubConfig.imagesPath.endsWith('/')) {
                    githubConfig.imagesPath += '/';
                }
                if (githubConfig.imagesPath === '/') { 
                    githubConfig.imagesPath = 'images/'; 
                    if (typeof showNotification === "function") showNotification('–ü—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–æ—Ä–Ω–µ–≤—ã–º. –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—É—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: images/', 'error');
                }

                localStorage.setItem('githubConfig', JSON.stringify({
                    owner: githubConfig.owner,
                    repo: githubConfig.repo,
                    branch: githubConfig.branch,
                    imagesPath: githubConfig.imagesPath
                }));

                document.body.removeChild(modal);
                if (typeof showNotification === "function") showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ GitHub —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã! –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...', 'info');
                if (typeof validateGitHubConfig === "function") validateGitHubConfig(); 
            });
        }
        
        async function validateGitHubConfig(showSuccessNotification = true) { 
            const manageImagesBtnContainer = document.getElementById('manageGitHubImagesBtnContainer');

            if (!githubConfig.owner || !githubConfig.repo) {
                if (showSuccessNotification && typeof showNotification === "function") showNotification('–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π GitHub –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–∫–∞–∑–∞–Ω—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏.', 'error');
                if (manageImagesBtnContainer) manageImagesBtnContainer.style.display = 'none';
                return false; 
            }
            if (!githubConfig.token) {
                if (showSuccessNotification && typeof showNotification === "function") showNotification('–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ GitHub –Ω–µ —É–∫–∞–∑–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –µ–≥–æ.', 'error');
                if (manageImagesBtnContainer) manageImagesBtnContainer.style.display = 'none';
                return false; 
            }

            const loadingIndicator = typeof showLoadingIndicator === "function" ? showLoadingIndicator('–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ GitHub...') : null;
            let isValid = false; 
            try {
                const response = await fetch(\`https://api.github.com/repos/\${githubConfig.owner}/\${githubConfig.repo}\`, {
                    headers: {
                        'Authorization': \`token \${githubConfig.token}\`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (loadingIndicator && typeof hideLoadingIndicator === "function") hideLoadingIndicator(loadingIndicator);

                if (response.ok) { 
                    if (showSuccessNotification && typeof showNotification === "function") showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ GitHub —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã! –ì–æ—Ç–æ–≤–æ –∫ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.', 'success');
                    if (manageImagesBtnContainer) manageImagesBtnContainer.style.display = 'inline-block'; 
                    isValid = true;
                } else if (response.status === 401) {
                    if (showSuccessNotification && typeof showNotification === "function") showNotification('–ü—Ä–æ–≤–µ—Ä–∫–∞ GitHub –ø—Ä–æ–≤–∞–ª–µ–Ω–∞: –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω.', 'error');
                    if (manageImagesBtnContainer) manageImagesBtnContainer.style.display = 'none';
                } else if (response.status === 403) {
                     if (showSuccessNotification && typeof showNotification === "function") showNotification('–ü—Ä–æ–≤–µ—Ä–∫–∞ GitHub –ø—Ä–æ–≤–∞–ª–µ–Ω–∞: –¢–æ–∫–µ–Ω –Ω–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã—Ö –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é.', 'error');
                     if (manageImagesBtnContainer) manageImagesBtnContainer.style.display = 'none';
                } else if (response.status === 404) {
                    if (showSuccessNotification && typeof showNotification === "function") showNotification('–ü—Ä–æ–≤–µ—Ä–∫–∞ GitHub –ø—Ä–æ–≤–∞–ª–µ–Ω–∞: –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.', 'error');
                    if (manageImagesBtnContainer) manageImagesBtnContainer.style.display = 'none';
                } else {
                    if (showSuccessNotification && typeof showNotification === "function") showNotification(\`–ü—Ä–æ–≤–µ—Ä–∫–∞ GitHub –ø—Ä–æ–≤–∞–ª–µ–Ω–∞: –û—à–∏–±–∫–∞ \${response.status}. \${response.statusText}\`, 'error');
                    if (manageImagesBtnContainer) manageImagesBtnContainer.style.display = 'none';
                }
            } catch (error) {
                if (loadingIndicator && typeof hideLoadingIndicator === "function") hideLoadingIndicator(loadingIndicator);
                console.error('–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ GitHub:', error);
                if (showSuccessNotification && typeof showNotification === "function") showNotification('–ü—Ä–æ–≤–µ—Ä–∫–∞ GitHub –ø—Ä–æ–≤–∞–ª–µ–Ω–∞: –ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –∏–ª–∏ GitHub –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.', 'error');
                if (manageImagesBtnContainer) manageImagesBtnContainer.style.display = 'none';
            }
            return isValid; 
        }

        function openManageGitHubImagesModal() {
            if (!currentArticleIdForManagement) {
                if(typeof showNotification === "function") showNotification("ID —Å—Ç–∞—Ç—å–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ –Ω–∞ GitHub —Ö–æ—Å—Ç–∏–Ω–≥ —Ö–æ—Ç—ã –±—ã —Ä–∞–∑.", "error");
                return;
            }

            const articleImages = JSON.parse(localStorage.getItem(\`article_\${currentArticleIdForManagement}_images\`) || '[]');
            const modal = document.createElement('div');
            modal.style.cssText = \`
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background-color: rgba(0,0,0,0.6); display: flex; align-items: center;
                justify-content: center; z-index: 10000; padding: 20px;
            \`;
            const modalContent = document.createElement('div');
            modalContent.style.cssText = \`
                background-color: white; padding: 25px; border-radius: 10px;
                width: 600px; max-width: 95%; max-height: 80vh; overflow-y: auto;
                box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            \`;
            modalContent.setAttribute('role', 'dialog');
            modalContent.setAttribute('aria-labelledby', 'manage-images-title');
            modalContent.setAttribute('aria-modal', 'true');

            modalContent.innerHTML = \`
                <h2 id="manage-images-title" style="margin-top: 0; color: #4facfe; margin-bottom:10px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ –¥–ª—è —Å—Ç–∞—Ç—å–∏:</h2>
                <p style="font-size:0.9em; color:#555; margin-bottom:20px;">ID —Å—Ç–∞—Ç—å–∏: <strong>\${currentArticleIdForManagement}</strong></p>
                <div id="githubImagesListModal" style="margin-bottom: 20px;"></div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                    <button id="github-manage-close" class="btn btn-secondary" style="background: #6c757d;">–ó–∞–∫—Ä—ã—Ç—å</button>
                    \${articleImages.length > 0 ? \`<button id="github-delete-all-article-images" class="btn" style="background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ (\${articleImages.length}) —Å GitHub</button>\` : ''}
                </div>
            \`;
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => { 
                if (e.target === modal) document.body.removeChild(modal);
            });
            document.getElementById('github-manage-close').addEventListener('click', () => document.body.removeChild(modal));

            if (document.getElementById('github-delete-all-article-images')) {
                document.getElementById('github-delete-all-article-images').addEventListener('click', () => {
                    if(typeof confirmAction === "function") confirmAction(\`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï (\${articleImages.length}) –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Å—Ç–∞—Ç—å–∏ \${currentArticleIdForManagement} —Å GitHub? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.\`, () => {
                        deleteArticleImages(currentArticleIdForManagement).then(() => {
                           if (modal.parentNode) document.body.removeChild(modal); 
                           if(typeof showNotification === "function") showNotification(\`–í—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Å—Ç–∞—Ç—å–∏ \${currentArticleIdForManagement} —É–¥–∞–ª–µ–Ω—ã.\`, 'success');
                        }).catch(err => {
                           if(typeof showNotification === "function") showNotification(\`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤—Å–µ—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: \${err.message}\`, 'error');
                        });
                    });
                });
            }
            renderGitHubImagesList(currentArticleIdForManagement, modalContent.querySelector('#githubImagesListModal'));
        }

        function renderGitHubImagesList(articleId, containerElement) {
            if (!containerElement) return;
            const articleImages = JSON.parse(localStorage.getItem(\`article_\${articleId}_images\`) || '[]');
            containerElement.innerHTML = ''; 

            if (articleImages.length === 0) {
                containerElement.innerHTML = '<p style="color: #777; text-align:center;">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è —ç—Ç–æ–π —Å—Ç–∞—Ç—å–∏ –Ω–∞ GitHub.</p>';
                const deleteAllBtn = document.getElementById('github-delete-all-article-images');
                if (deleteAllBtn) {
                    deleteAllBtn.disabled = true;
                    deleteAllBtn.style.opacity = '0.6';
                    deleteAllBtn.textContent = '–£–¥–∞–ª–∏—Ç—å –≤—Å–µ (0) —Å GitHub';
                }
                return;
            }

            const ul = document.createElement('ul');
            ul.style.cssText = 'list-style: none; padding: 0;';
            articleImages.forEach(image => {
                const li = document.createElement('li');
                li.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;';
                const imgPreview = document.createElement('img');
                imgPreview.src = image.url; 
                imgPreview.alt = image.filename;
                imgPreview.style.cssText = 'width: 50px; height: 50px; object-fit: cover; border-radius: 4px; margin-right: 15px;';
                const fileNameSpan = document.createElement('span');
                fileNameSpan.textContent = image.filename;
                fileNameSpan.style.flexGrow = '1';
                fileNameSpan.style.fontSize = '0.9em';
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = 'üóëÔ∏è';
                deleteBtn.className = 'btn';
                deleteBtn.setAttribute('aria-label', \`–£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ \${image.filename} —Å GitHub\`);
                deleteBtn.title = \`–£–¥–∞–ª–∏—Ç—å \${image.filename} —Å GitHub\`;
                deleteBtn.style.cssText = 'background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%); padding: 5px 10px; font-size: 14px; margin-left:10px;';
                deleteBtn.onclick = () => {
                    if(typeof confirmAction === "function") confirmAction(\`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å "\${image.filename}" —Å GitHub?\`, () => {
                        deleteSingleImageFromGitHub(articleId, image.filename, image.sha)
                            .then(() => {
                                if(typeof showNotification === "function") showNotification(\`–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ "\${image.filename}" —É–¥–∞–ª–µ–Ω–æ —Å GitHub.\`, 'success');
                                renderGitHubImagesList(articleId, containerElement); 
                                const deleteAllBtn = document.getElementById('github-delete-all-article-images');
                                const updatedImages = JSON.parse(localStorage.getItem(\`article_\${articleId}_images\`) || '[]');
                                if (deleteAllBtn) {
                                    if (updatedImages.length > 0) {
                                     deleteAllBtn.textContent = \`–£–¥–∞–ª–∏—Ç—å –≤—Å–µ (\${updatedImages.length}) —Å GitHub\`;
                                     deleteAllBtn.disabled = false;
                                     deleteAllBtn.style.opacity = '1';
                                    } else {
                                     deleteAllBtn.textContent = '–£–¥–∞–ª–∏—Ç—å –≤—Å–µ (0) —Å GitHub';
                                     deleteAllBtn.disabled = true;
                                     deleteAllBtn.style.opacity = '0.6';
                                    }
                                }
                            })
                            .catch(err => { if(typeof showNotification === "function") showNotification(\`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è "\${image.filename}": \${err.message}\`, 'error')});
                    });
                };
                const imageInfoDiv = document.createElement('div');
                imageInfoDiv.style.display = 'flex';
                imageInfoDiv.style.alignItems = 'center';
                imageInfoDiv.appendChild(imgPreview);
                imageInfoDiv.appendChild(fileNameSpan);
                li.appendChild(imageInfoDiv);
                li.appendChild(deleteBtn);
                ul.appendChild(li);
            });
            containerElement.appendChild(ul);
        }
        
        async function deleteSingleImageFromGitHub(articleId, filename, sha) {
            if (!githubConfig.owner || !githubConfig.repo || !githubConfig.token) {
                if(typeof showNotification === "function") showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ GitHub –Ω–µ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω—ã.', 'error');
                throw new Error('GitHub config missing');
            }
            const imagePath = \`\${githubConfig.imagesPath}\${articleId}/\${filename}\`;
            const response = await fetch(\`https://api.github.com/repos/\${githubConfig.owner}/\${githubConfig.repo}/contents/\${imagePath}\`, {
                method: 'DELETE',
                headers: {
                    'Authorization': \`token \${githubConfig.token}\`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: \`Delete image \${filename} for article \${articleId} via PublikaTor\`,
                    sha: sha,
                    branch: githubConfig.branch
                })
            });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: response.statusText }));
                console.error(\`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è \${filename} —Å GitHub:\`, errorData);
                throw new Error(\`GitHub API: \${errorData.message || response.status}\`);
            }
            let articleImages = JSON.parse(localStorage.getItem(\`article_\${articleId}_images\`) || '[]');
            articleImages = articleImages.filter(img => img.filename !== filename);
            localStorage.setItem(\`article_\${articleId}_images\`, JSON.stringify(articleImages));
            return await response.json();
        }

        async function uploadImageToGitHub(dataUrl, filename, articleId) {
            currentArticleIdForManagement = articleId; 
            if (!githubConfig.owner || !githubConfig.repo || !githubConfig.token) {
                if(typeof showNotification === "function") showNotification('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å GitHub. –ù–∞–∂–º–∏—Ç–µ ‚öôÔ∏è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.', 'error');
                throw new Error('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å GitHub');
            }
            try {
                const base64Data = dataUrl.split(',')[1];
                const imagePath = \`\${githubConfig.imagesPath}\${articleId}/\${filename}\`;
                let fileSha = null;
                try {
                    const fileResponse = await fetch(\`https://api.github.com/repos/\${githubConfig.owner}/\${githubConfig.repo}/contents/\${imagePath}?ref=\${githubConfig.branch}\`, {
                        headers: { 'Authorization': \`token \${githubConfig.token}\`, 'Accept': 'application/vnd.github.v3+json' }
                    });
                    if (fileResponse.ok) {
                        const fileData = await fileResponse.json();
                        fileSha = fileData.sha;
                    }
                } catch (error) { console.log('–§–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π'); }

                const response = await fetch(\`https://api.github.com/repos/\${githubConfig.owner}/\${githubConfig.repo}/contents/\${imagePath}\`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': \`token \${githubConfig.token}\`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: \`Upload image \${filename} for article \${articleId}\`,
                        content: base64Data, branch: githubConfig.branch, sha: fileSha
                    })
                });
                if (!response.ok) throw new Error(\`GitHub API error: \${response.status} \${response.statusText}\`);
                const data = await response.json();
                saveImageInfo(articleId, filename, data.content.sha, data.content.html_url);
                return \`https://raw.githubusercontent.com/\${githubConfig.owner}/\${githubConfig.repo}/\${githubConfig.branch}/\${imagePath}\`;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ GitHub:', error);
                if(typeof showNotification === "function") showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ GitHub: ' + error.message, 'error');
                throw error;
            }
        }

        function saveImageInfo(articleId, filename, sha, url) {
            let articleImages = JSON.parse(localStorage.getItem(\`article_\${articleId}_images\`) || '[]');
            articleImages.push({ filename, sha, url, uploadedAt: new Date().toISOString() });
            localStorage.setItem(\`article_\${articleId}_images\`, JSON.stringify(articleImages));
        }

        async function deleteArticleImages(articleId) { 
            if (!githubConfig.owner || !githubConfig.repo || !githubConfig.token) {
                if (typeof setupGitHub === "function") setupGitHub(); // Should ideally not happen if UI controls this
                else if(typeof showNotification === "function") showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ GitHub –Ω–µ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω—ã.', 'error');
                throw new Error('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å GitHub');
            }
            const articleImages = JSON.parse(localStorage.getItem(\`article_\${articleId}_images\`) || '[]');
            if (articleImages.length === 0) {
                if(typeof showNotification === "function") showNotification('–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'info');
                return;
            }
            const loadingIndicator = typeof showLoadingIndicator === "function" ? showLoadingIndicator('–£–¥–∞–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...') : null;
            try {
                for (const image of articleImages) {
                    const imagePath = \`\${githubConfig.imagesPath}\${articleId}/\${image.filename}\`;
                    const response = await fetch(\`https://api.github.com/repos/\${githubConfig.owner}/\${githubConfig.repo}/contents/\${imagePath}\`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': \`token \${githubConfig.token}\`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: \`Delete image \${image.filename} for article \${articleId}\`,
                            sha: image.sha, branch: githubConfig.branch
                        })
                    });
                    if (!response.ok) console.error(\`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è \${image.filename}:\`, await response.text());
                }
                localStorage.removeItem(\`article_\${articleId}_images\`);
                if (loadingIndicator && typeof hideLoadingIndicator === "function") hideLoadingIndicator(loadingIndicator);
                if(typeof showNotification === "function") showNotification(\`–£–¥–∞–ª–µ–Ω–æ \${articleImages.length} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è —Å—Ç–∞—Ç—å–∏ \${articleId}\`, 'success');
            } catch (error) {
                if (loadingIndicator && typeof hideLoadingIndicator === "function") hideLoadingIndicator(loadingIndicator);
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', error);
                if(typeof showNotification === "function") showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: ' + error.message, 'error');
                throw error;
            }
        }

        function generateArticleId() {
            let title = '';
            const previewContentElement = document.getElementById('previewContent');
            if (previewContentElement) {
                 const titleElement = previewContentElement.querySelector('h1, h2, h3, p');
                 if (titleElement) title = titleElement.textContent || '';
            }
            const titleSlug = title.toLowerCase().replace(/[^\\w\\s-]/g, '').replace(/\\s+/g, '-').substring(0, 30);
            const timestamp = Date.now().toString(36);
            return \`\${titleSlug}-\${timestamp}\`;
        }

        function showNotification(message, type = 'info', duration = 5000, buttons = null) {
            const container = document.getElementById('notification-container');
            if (!container) { // Fallback if container not in DOM (e.g. very early tests)
                console.log(\`Notification (\${type}): \${message}\`);
                return;
            }
            const notification = document.createElement('div');
            notification.className = \`custom-notification \${type}\`;
            notification.textContent = message;
            if (type === 'error' || type === 'success' || type === 'info') {
                 notification.setAttribute('role', 'alert');
            }
            if (buttons) {
                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'notification-buttons';
                buttons.forEach(btnConfig => {
                    const button = document.createElement('button');
                    button.textContent = btnConfig.text;
                    button.className = btnConfig.className;
                    button.onclick = () => {
                        btnConfig.action();
                        if (notification.parentNode === container) { 
                           container.removeChild(notification);
                        }
                    };
                    buttonsDiv.appendChild(button);
                });
                notification.appendChild(buttonsDiv);
            }
            container.insertBefore(notification, container.firstChild); 
            if (duration > 0) { 
                setTimeout(() => {
                    if (notification.parentNode === container) { 
                         container.removeChild(notification);
                    }
                }, duration);
            }
            return notification; 
        }

        function confirmAction(message, onConfirm, onCancel = () => {}) {
            showNotification(message, 'confirm', 0, [ 
                { text: '–î–∞', className: 'confirm-yes', action: onConfirm },
                { text: '–û—Ç–º–µ–Ω–∞', className: 'confirm-cancel', action: onCancel }
            ]);
        }

        function showLoadingIndicator(message) {
            const existingIndicator = document.getElementById('loading-indicator-global');
            if (existingIndicator) {
                existingIndicator.querySelector('p').textContent = message;
                return existingIndicator;
            }
            const loadingIndicator = document.createElement('div');
            loadingIndicator.id = 'loading-indicator-global';
            loadingIndicator.style.cssText = \`
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center;
                justify-content: center; z-index: 99999;
            \`;
            loadingIndicator.innerHTML = \`
                <div style="background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 0 15px rgba(0,0,0,0.2);">
                    <div class="spinner" style="border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
                    <p style="color: #333; font-size: 1em;">\${message}</p>
                </div>
            \`;
            document.body.appendChild(loadingIndicator);
            return loadingIndicator;
        }

        function hideLoadingIndicator(loadingIndicator) {
            if (loadingIndicator && loadingIndicator.parentNode && loadingIndicator.id === 'loading-indicator-global') {
                loadingIndicator.parentNode.removeChild(loadingIndicator);
            }
        }
        
        async function copyForZenWithGitHub() {
            const textEditor = document.getElementById('textEditor');
            if (!processedContent && textEditor && textEditor.value.trim() === '') { // Avoid preview if editor empty
                 showNotification('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª!', 'error'); return;
            }
            if (!processedContent) {
                if (typeof generatePreview === "function") generatePreview();
                if (!processedContent) { 
                    showNotification('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä!', 'error');
                    return;
                }
            }
            const articleId = typeof generateArticleId === "function" ? generateArticleId() : 'unknown-article';
            currentArticleIdForManagement = articleId;

            const loadingIndicator = typeof showLoadingIndicator === "function" ? showLoadingIndicator('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –î–∑–µ–Ω–∞...') : null;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = processedContent; 
            const uploadPromises = [];
            const figureElements = tempDiv.querySelectorAll('figure');

            for (const figure of figureElements) {
                const imgElement = figure.querySelector('img');
                if (!imgElement) continue; 
                const originalSrc = imgElement.getAttribute('src');
                const isLocalImage = originalSrc.startsWith('data:image');
                if (isLocalImage) {
                    let filename = null;
                    for (const [key, value] of uploadedImages.entries()) {
                        if (value === originalSrc) { filename = key; break; }
                    }
                    if (filename) {
                        const uploadPromise = uploadImageToGitHub(originalSrc, filename, articleId)
                            .then(publicUrl => {
                                imgElement.src = publicUrl;
                                imgElement.setAttribute('width', '100%');
                                imgElement.setAttribute('height', 'auto');
                                imgElement.setAttribute('data-original-src', filename);
                                imgElement.setAttribute('data-article-id', articleId);
                                imgElement.removeAttribute('style');
                                imgElement.removeAttribute('onload');
                                imgElement.removeAttribute('onerror');
                            })
                            .catch(error => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–æ—Å—Ç–∞–Ω–µ—Ç—Å—è dataUrl):', error));
                        uploadPromises.push(uploadPromise);
                    }
                } else if (originalSrc.startsWith('http')) {
                    imgElement.setAttribute('width', '100%');
                    imgElement.setAttribute('height', 'auto');
                    imgElement.setAttribute('data-original-src', originalSrc);
                    imgElement.setAttribute('data-article-id', articleId);
                    imgElement.removeAttribute('style');
                    imgElement.removeAttribute('onload');
                    imgElement.removeAttribute('onerror');
                    const errorDiv = imgElement.nextElementSibling;
                    if (errorDiv && errorDiv.tagName === 'DIV' && errorDiv.style.display === 'none') errorDiv.remove();
                }
            }

            Promise.all(uploadPromises)
                .then(() => {
                    let zenHtml = tempDiv.innerHTML;
                    zenHtml = zenHtml.replace(/style="[^"]*"/g, match => (match.includes('text-align') || match.includes('font-style') || match.includes('color') || match.includes('font-size')) ? match : '');
                    zenHtml = zenHtml.replace(/onload="[^"]*"/g, '').replace(/onerror="[^"]*"/g, '');
                    zenHtml = zenHtml.replace(/<div style="display: none; background:[^>]+>.*?<\/div>/g, '');
                    zenHtml = zenHtml.replace(/\\n\\s*\\n/g, '\\n').trim();
                    if (typeof copyHtmlToClipboard === "function") copyHtmlToClipboard(zenHtml);
                    if (loadingIndicator && typeof hideLoadingIndicator === "function") hideLoadingIndicator(loadingIndicator);
                    if (typeof showNotification === "function") showNotification(\`–ö–æ–Ω—Ç–µ–Ω—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –¥–ª—è –î–∑–µ–Ω–∞! ID —Å—Ç–∞—Ç—å–∏: \${articleId}\`, 'success');
                    if (typeof addDeleteImagesButton === "function") addDeleteImagesButton(articleId);
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', error);
                    if (loadingIndicator && typeof hideLoadingIndicator === "function") hideLoadingIndicator(loadingIndicator);
                    if (typeof showNotification === "function") showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 'error');
                });
        }

        function addDeleteImagesButton(articleId) {
            const existingButton = document.getElementById(\`delete-images-\${articleId}\`);
            if (existingButton) return;

            const deleteButton = document.createElement('button');
            deleteButton.id = \`delete-images-\${articleId}\`;
            deleteButton.className = 'btn';
            deleteButton.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%)';
            deleteButton.style.marginLeft = '10px';
            deleteButton.innerHTML = 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—å–∏';
            deleteButton.title = \`–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Å—Ç–∞—Ç—å–∏ \${articleId}\`;
            deleteButton.setAttribute('aria-label', \`–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Å—Ç–∞—Ç—å–∏ \${articleId}\`);

            deleteButton.addEventListener('click', () => {
                if(typeof confirmAction === "function") confirmAction(\`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Å—Ç–∞—Ç—å–∏ \${articleId}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.\`, () => {
                    deleteArticleImages(articleId)
                        .then(() => {
                            if (deleteButton.parentNode) deleteButton.parentNode.removeChild(deleteButton);
                            const modal = document.querySelector('div[style*="z-index: 10000"]'); 
                            if (modal && currentArticleIdForManagement === articleId) {
                                const listContainer = modal.querySelector('#githubImagesListModal'); // Corrected ID
                                if (listContainer) renderGitHubImagesList(articleId, listContainer);
                            }
                        });
                });
            });
            const zenCopyBtn = document.getElementById('zenCopyBtn');
            if (zenCopyBtn && zenCopyBtn.parentNode) zenCopyBtn.parentNode.appendChild(deleteButton);
            else {
                const zenCopyBtn2 = document.getElementById('zenCopyBtn2');
                if (zenCopyBtn2 && zenCopyBtn2.parentNode) zenCopyBtn2.parentNode.appendChild(deleteButton);
            }
        }

        async function uploadImageToExternalHost(dataUrl, filename) {
            try {
                const articleId = typeof generateArticleId === "function" ? generateArticleId() : 'unknown-article-ext';
                return await uploadImageToGitHub(dataUrl, filename, articleId);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (external host):', error);
                return \`https://cdn.publikator.demo/img_\${Date.now()}_\${Math.random().toString(36).substr(2, 9)}/\${filename}\`;
            }
        }

        function dataURLtoBlob(dataURL) {
            return new Promise((resolve) => {
                const arr = dataURL.split(',');
                const mime = arr[0].match(/:(.*?);/)[1];
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);
                while (n--) u8arr[n] = bstr.charCodeAt(n);
                resolve(new Blob([u8arr], { type: mime }));
            });
        }

        function copyHtmlToClipboard(html) {
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.innerHTML = html;
            document.body.appendChild(tempDiv);
            try {
                if (navigator.clipboard && navigator.clipboard.write) {
                    const clipboardItem = new ClipboardItem({
                        'text/html': new Blob([html], { type: 'text/html' }),
                        'text/plain': new Blob([tempDiv.textContent || tempDiv.innerText || ''], { type: 'text/plain' })
                    });
                    navigator.clipboard.write([clipboardItem])
                        .then(() => { if (typeof showCopySuccess === "function") showCopySuccess(); }) // showCopySuccess might not be defined
                        .catch(err => {
                            console.error('–û—à–∏–±–∫–∞ Clipboard API:', err);
                            if (typeof fallbackCopyMethod === "function") fallbackCopyMethod(tempDiv);
                        });
                } else {
                    if (typeof fallbackCopyMethod === "function") fallbackCopyMethod(tempDiv);
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                if (typeof fallbackCopyMethod === "function") fallbackCopyMethod(tempDiv);
            } finally {
                if (tempDiv.parentNode) tempDiv.parentNode.removeChild(tempDiv);
            }
        }

        function fallbackCopyMethod(element) {
            const range = document.createRange();
            range.selectNodeContents(element);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            let successful = false;
            try {
                successful = document.execCommand('copy');
                if (!successful) {
                   if(typeof showNotification === "function") showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç —á–µ—Ä–µ–∑ execCommand. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é (Ctrl+C).', 'error');
                } else {
                   if(typeof showNotification === "function") showNotification('–ö–æ–Ω—Ç–µ–Ω—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω (fallback –º–µ—Ç–æ–¥).', 'success');
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ fallback –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                if(typeof showNotification === "function") showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ fallback –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é (Ctrl+C).', 'error');
            }
            if (window.getSelection) window.getSelection().removeAllRanges();
        }

        function showCopySuccess() { // This function seems tied to a specific element #copySuccess
            const successDiv = document.getElementById('copySuccess');
            if (successDiv) {
                successDiv.style.display = 'block';
                const btn = document.getElementById('zenCopyBtn') || document.getElementById('zenCopyBtn2');
                if (btn) {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –î–∑–µ–Ω–∞!';
                    btn.style.background = '#28a745';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = '';
                        successDiv.style.display = 'none';
                    }, 3000);
                }
            } else { // Fallback to general notification if #copySuccess is not found
                if(typeof showNotification === "function") showNotification('–ö–æ–Ω—Ç–µ–Ω—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –¥–ª—è –î–∑–µ–Ω–∞!', 'success');
            }
        }

        function publishContent() {
            const textEditor = document.getElementById('textEditor');
            if (!processedContent && textEditor && textEditor.value.trim() === '') {
                if(typeof showNotification === "function") showNotification('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª!', 'error'); return;
            }
            if (!processedContent) {
                if (typeof generatePreview === "function") generatePreview();
                if (!processedContent) {
                    if(typeof showNotification === "function") showNotification('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä!', 'error');
                    return;
                }
            }
            const loading = document.getElementById('loading');
            const publishResult = document.getElementById('publishResult');
            const publishedContentDiv = document.getElementById('publishedContent');
            const finalContentDiv = document.getElementById('finalContent');

            if(loading) loading.style.display = 'block';
            if(publishResult) publishResult.innerHTML = '';

            setTimeout(() => {
                if(finalContentDiv) finalContentDiv.innerHTML = processedContent;
                if(publishedContentDiv) publishedContentDiv.style.display = 'block';
                if(typeof createFullHtmlPage === "function") window.publishedHtml = createFullHtmlPage(processedContent);
                if(loading) loading.style.display = 'none';
                if(publishResult) publishResult.innerHTML = \`
                    <div class="publish-url">
                        <strong>‚úÖ –ö–æ–Ω—Ç–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!</strong><br><br>
                        <p style="color: rgba(255,255,255,0.9);">–í–∞—à–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∏–∂–µ –∏ –≥–æ—Ç–æ–≤–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</p>
                    </div>
                \`;
                if(publishedContentDiv) setTimeout(() => publishedContentDiv.scrollIntoView({ behavior: 'smooth' }), 500);
            }, 1500);
        }

        function downloadCurrentPage() {
            const htmlContent = window.publishedHtml;
            if (htmlContent) {
                const pageId = 'page_' + Date.now();
                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = \`published_page_\${pageId}.html\`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } else {
                if(typeof showNotification === "function") showNotification('–°–Ω–∞—á–∞–ª–∞ –æ–ø—É–±–ª–∏–∫—É–π—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç!', 'error');
            }
        }

        function createFullHtmlPage(content) {
            return \`<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</title>
    <style>
        body { font-family: 'Times New Roman', Times, serif; margin: 20px auto; max-width: 800px; padding: 0 20px; line-height: 1.6; color: #333; }
        figure { margin: 20px 0; text-align: center; }
        img { max-width: 100%; height: auto; display: block; margin: 0 auto; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        p { margin: 1em 0; }
        figcaption { font-style: italic; color: #555; text-align: center; margin-top: 8px; font-size: 0.9em; }
        div[style*="background: #ffebee"] { border: 1px solid #c62828; padding: 10px; margin: 10px 0; border-radius: 4px; }
    </style>
</head>
<body>
    \${content}
</body>
</html>\`;
        }

        function clearAll() {
            if(typeof confirmAction === "function") confirmAction("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—Å–µ –æ—á–∏—Å—Ç–∏—Ç—å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.", () => {
                const textEditor = document.getElementById('textEditor');
                const previewContent = document.getElementById('previewContent');
                const imagesList = document.getElementById('imagesList');
                const publishResult = document.getElementById('publishResult');
                const publishedContent = document.getElementById('publishedContent');

                if(textEditor) textEditor.value = '';
                if(previewContent) previewContent.innerHTML = '<p style="text-align: center; color: #999; font-style: italic;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä"</p>';
                if(imagesList) imagesList.innerHTML = '';
                if(publishResult) publishResult.innerHTML = '';
                if(publishedContent) publishedContent.style.display = 'none';

                uploadedImages.clear();
                imageUrlMap.clear();
                processedContent = '';
                window.publishedHtml = '';
                const deleteButtons = document.querySelectorAll('button[id^="delete-images-"]');
                deleteButtons.forEach(btn => btn.remove());
                if(typeof showNotification === "function") showNotification('–í—Å–µ –ø–æ–ª—è –æ—á–∏—â–µ–Ω—ã.', 'info', 2000);
            });
        }

        function copyToClipboard() {
             if (window.publishedHtml) {
                navigator.clipboard.writeText(window.publishedHtml).then(() => {
                    if(typeof showNotification === "function") showNotification('HTML –∫–æ–¥ –ø–æ–ª–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
                }).catch(err => {
                    if(typeof showNotification === "function") showNotification('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è HTML: ' + err, 'error');
                    console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è HTML:', err);
                });
            } else {
                if(typeof showNotification === "function") showNotification('–°–Ω–∞—á–∞–ª–∞ –æ–ø—É–±–ª–∏–∫—É–π—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å HTML –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.', 'error');
            }
        }

        if (typeof document !== 'undefined') { // Guard for non-browser environments if script were ever run there
            document.addEventListener('DOMContentLoaded', function() {
                const savedConfig = JSON.parse(localStorage.getItem('githubConfig') || '{}');
                if (savedConfig.owner) githubConfig.owner = savedConfig.owner;
                if (savedConfig.repo) githubConfig.repo = savedConfig.repo;
                if (savedConfig.branch) githubConfig.branch = savedConfig.branch;
                if (savedConfig.imagesPath) githubConfig.imagesPath = savedConfig.imagesPath;
                
                const fileUploadSection = document.querySelector('.file-upload');
                if (fileUploadSection && typeof setupGitHub === "function") { // Check if setupGitHub is defined
                    const setupButton = document.createElement('div');
                    setupButton.className = 'file-input-wrapper';
                    setupButton.style.background = 'linear-gradient(135deg, #333 0%, #666 100%)';
                    setupButton.innerHTML = '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitHub';
                    setupButton.style.cursor = 'pointer';
                    setupButton.addEventListener('click', setupGitHub);
                    fileUploadSection.appendChild(setupButton);
                }
            });
        }
    </script>
    <!-- End of Copied JavaScript -->

    <script src="tests.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const resultsList = document.getElementById('resultsList');
            const totalTestsEl = document.getElementById('totalTests');
            const testsPassedEl = document.getElementById('testsPassed');
            const testsFailedEl = document.getElementById('testsFailed');

            // Ensure mocks are set up before running tests, and index.html's JS has loaded.
            // The global setupMocks() from tests.js is called by runAllTests().
            
            const results = await runAllTests(); // from tests.js

            totalTestsEl.textContent = TestSuite.totalRun; // Use totals from TestSuite
            testsPassedEl.textContent = TestSuite.totalPassed;
            testsFailedEl.textContent = TestSuite.totalRun - TestSuite.totalPassed;

            results.forEach(result => {
                const li = document.createElement('li');
                li.className = result.status === "PASS" ? "pass" : "fail";
                li.innerHTML = \`<strong>\${result.name}:</strong> \${result.status}\`;
                if (result.error) {
                    const pre = document.createElement('pre');
                    pre.textContent = result.error;
                    li.appendChild(pre);
                }
                resultsList.appendChild(li);
            });
        });
    </script>
</body>
</html>
