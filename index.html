<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Публикатор контента - Дзен версия (Улучшенный)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 600px;
        }

        .editor-section {
            padding: 30px;
            border-right: 1px solid #e0e0e0;
        }

        .preview-section {
            padding: 30px;
            background: #f8f9fa;
        }

        .section-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .file-upload {
            margin-bottom: 20px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .file-input-wrapper:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .file-input-wrapper input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        textarea {
            width: 100%;
            height: 300px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-zen {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .preview-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            font-family: 'Times New Roman', Times, serif;
            font-size: 16px;
            line-height: 1.6;
            color: #333;
        }

        .preview-content figure {
            margin: 20px 0;
            text-align: center;
        }

        .preview-content img {
            max-width: 100%;
            height: auto;
            border-radius: 0;
            margin: 0 auto; /* Центрируем внутри figure */
            box-shadow: none;
            display: block;
        }

        .preview-content p {
            margin: 16px 0;
            text-align: left;
        }

        .preview-content figcaption {
            font-style: italic;
            color: #666;
            text-align: center;
            margin: 8px 0 0 0; /* Отступ сверху */
            font-size: 14px;
            font-family: 'Times New Roman', Times, serif;
        }

        .help-text {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .help-text strong {
            color: #1976d2;
        }

        .zen-help {
            background: #e8f5e8;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        .zen-help strong {
            color: #28a745;
        }

        .images-list {
            margin-top: 15px;
        }

        .image-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #f0f0f0;
            border-radius: 6px;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .image-item img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 10px;
        }

        .publish-section {
            grid-column: 1 / -1;
            padding: 30px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            text-align: center;
        }

        .publish-url {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .editor-section {
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .copy-success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
            display: none;
        }

        /* Стили для GitHub интеграции */
        .github-settings {
            background: #f8f9fa;
            border-left: 4px solid #333;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        .github-settings strong {
            color: #333;
        }

        /* Удаляем .image-container, т.к. используем figure */
        /* .image-container { ... } */

        /* Стили для figcaption уже есть выше */

        details {
            border: 1px solid #eee; /* Lighter border for details */
            border-radius: 8px;
            margin-bottom: 15px; /* Adjusted margin */
            background: rgba(255,255,255,0.02);
        }
        details[open] {
            background: rgba(255,255,255,0.05);
        }
        summary {
            padding: 12px 15px; /* Adjusted padding */
            cursor: pointer;
            font-weight: 600;
            outline: none;
            list-style-position: inside; 
            color: #333; /* Ensure summary text is dark enough */
        }
        summary::marker { /* Styling for the arrow */
            color: #4facfe; 
        }
        .help-text-content, .zen-help-content, .github-settings-content {
            padding: 0 15px 15px 15px;
            font-size: 0.9em;
            line-height: 1.5;
            color: #333; /* Ensure content text is dark enough */
        }
        .help-text-content code {
             background-color: rgba(0,0,0,0.07); /* Slightly darker code background */
             padding: 2px 5px;
             border-radius: 4px;
             font-family: 'Courier New', monospace;
        }
        
        /* Notification container for aria-live */
        #notification-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column-reverse; /* New notifications appear on top */
            gap: 10px;
        }
        .custom-notification {
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            max-width: 320px; /* Max width for notifications */
            word-break: break-word;
            opacity: 0.95;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .custom-notification.success {
            background-color: #d4edda; color: #155724; border-left: 4px solid #28a745;
        }
        .custom-notification.error {
            background-color: #f8d7da; color: #721c24; border-left: 4px solid #dc3545;
        }
        .custom-notification.info {
            background-color: #e3f2fd; color: #0c5460; border-left: 4px solid #17a2b8;
        }
        .custom-notification.confirm {
            background-color: #fff3cd; color: #856404; border-left: 4px solid #ffc107;
        }
        .notification-buttons {
            margin-top: 10px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        .notification-buttons button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        .notification-buttons .confirm-yes {
            background-color: #28a745; color: white;
        }
        .notification-buttons .confirm-no {
            background-color: #dc3545; color: white;
        }
        .notification-buttons .confirm-cancel {
            background-color: #6c757d; color: white;
        }

    </style>
</head>
<body>
    <div id="notification-container" aria-live="assertive" aria-atomic="true"></div>

    <div class="container">
        <header class="header" role="banner">
            <h1>📝 Публикатор контента (Дзен версия)</h1>
            <p>Создавайте контент с полной совместимостью с Яндекс.Дзеном</p>
        </header>

        <main class="main-content" role="main">
            <section class="editor-section" role="region" aria-labelledby="editor-title">
                <h2 class="section-title" id="editor-title">Редактор</h2>

                <div class="zen-help">
                    <details>
                        <summary>🎯 Оптимизировано для Яндекс.Дзена!</summary>
                        <div class="zen-help-content">
                        Теперь при копировании контента генерируется HTML, полностью совместимый с редактором Дзена. Изображения и подписи к ним переносятся корректно.
                        </div>
                    </details>
                </div>

                <div class="github-settings">
                     <details>
                        <summary>⚙️ Интеграция с GitHub!</summary>
                        <div class="github-settings-content">
                        Загружайте изображения в свой GitHub репозиторий и управляйте ими одной кнопкой. Настройте интеграцию, чтобы начать работу.
                        </div>
                    </details>
                </div>

                <div class="help-text">
                    <details open> <!-- Keep this one open by default for critical instructions -->
                        <summary>💡 Формат для вставки изображений и подсказки</summary>
                        <div class="help-text-content">
                        <code>[IMG:название_файла.jpg] подпись к изображению</code> - для загруженных файлов<br>
                        <code>[URL:https://example.com/image.jpg] подпись к изображению</code> - для онлайн картинок<br><br>
                        <strong>Примеры:</strong><br>
                        <code>[IMG:photo1.jpg] Красивый закат над морем</code><br>
                        <code>[URL:https://picsum.photos/600/400] Случайное изображение</code>
                        <br><br>
                        Используйте двойной перенос строки для создания нового абзаца.
                        </div>
                    </details>
                </div>

                <div class="file-upload">
                    <div class="file-input-wrapper">
                        <input type="file" id="textFile" accept=".txt" aria-label="Загрузить текстовый файл">
                        📄 Загрузить текст (.txt)
                    </div>

                    <div class="file-input-wrapper">
                        <input type="file" id="imageFiles" multiple accept="image/*" aria-label="Загрузить изображения">
                        🖼️ Загрузить изображения
                    </div>
                     <div class="file-input-wrapper" id="manageGitHubImagesBtnContainer" style="display: none;">
                        <button class="btn btn-secondary" onclick="openManageGitHubImagesModal()" aria-label="Управление изображениями на GitHub">🖼️ Управление изображениями (GitHub)</button>
                    </div>
                </div>

                <div class="images-list" id="imagesList" aria-live="polite"></div>

                <textarea id="textEditor" aria-label="Текстовый редактор" placeholder="Вставьте ваш текст здесь или загрузите файл...

Пример использования:
Добро пожаловать на мой сайт!

[IMG:photo1.jpg] Это моя загруженная фотография

Здесь может быть любой текст...

[URL:https://picsum.photos/600/400] А это картинка из интернета

Еще текст...

[URL:https://images.unsplash.com/photo-1506905925346-21bda4d32df4] Красивый пейзаж с Unsplash"></textarea>

                <div>
                    <button class="btn" onclick="generatePreview()" aria-label="Предварительный просмотр">👁️ Предварительный просмотр</button>
                    <button class="btn btn-secondary" onclick="clearAll()" aria-label="Очистить всё">🗑️ Очистить</button>
                </div>

                <div class="copy-success" id="copySuccess" aria-live="polite">
                    ✅ Контент скопирован в буфер обмена в формате, оптимизированном для Дзена!
                </div>
            </section>

            <aside class="preview-section" role="region" aria-labelledby="preview-title">
                <h2 class="section-title" id="preview-title">Предварительный просмотр</h2>
                <div class="preview-content" id="previewContent" aria-live="polite">
                    <p style="text-align: center; color: #999; font-style: italic;">
                        Загрузите текст и изображения, затем нажмите "Предварительный просмотр"
                    </p>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-zen" onclick="copyForZenWithGitHub()" id="zenCopyBtn" aria-label="Копировать для Дзена">
                        📋 Копировать для Дзена
                    </button>
                </div>
            </aside>
        </main>

        <section class="publish-section" role="region" aria-labelledby="publish-title">
            <h2 id="publish-title">🚀 Публикация</h2>
            <p>Ваш контент будет опубликован прямо здесь в этом артефакте</p>

            <div class="loading" id="loading" aria-live="assertive">
                <div class="spinner"></div>
                <p>Подготовка публикации...</p>
            </div>

            <button class="btn" onclick="publishContent()" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); font-size: 18px; padding: 15px 30px;" aria-label="Опубликовать здесь">
                📤 Опубликовать здесь
            </button>

            <div id="publishResult" aria-live="polite"></div>

            <!-- Область для опубликованного контента -->
            <div id="publishedContent" style="display: none;" aria-live="polite">
                <div style="border-top: 3px solid #4facfe; margin-top: 30px; padding-top: 30px;">
                    <h2 style="text-align: center; color: white; margin-bottom: 20px;">📄 Опубликованная страница:</h2>
                    <div style="background: white; border-radius: 10px; padding: 30px; color: #333; max-height: 600px; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                        <div id="finalContent" aria-live="polite" style="
                            font-family: 'Times New Roman', Times, serif;
                            font-size: 16px;
                            line-height: 1.6;
                            color: #333;
                            max-width: 100%;
                        "></div>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="downloadCurrentPage()">💾 Скачать HTML</button>
                        <button class="btn btn-secondary" onclick="copyToClipboard()">📋 Копировать HTML</button>
                        <button class="btn btn-zen" onclick="copyForZenWithGitHub()" id="zenCopyBtn2">📄 Копировать для Дзена</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Конфигурация GitHub
        const githubConfig = {
            // Эти значения должны быть заполнены пользователем
            owner: '', // Имя пользователя GitHub
            repo: '', // Название репозитория
            branch: 'main', // Ветка по умолчанию
            token: '', // Персональный токен доступа GitHub
            imagesPath: 'images/' // Путь к папке с изображениями в репозитории
        };

        let uploadedImages = new Map();
        let processedContent = '';
        let imageUrlMap = new Map(); // Маппинг локальных изображений на публичные URL

        // Симуляция CDN URL для изображений (в реальной реализации это должен быть настоящий CDN)
        function generatePublicImageUrl(filename, dataUrl) {
            // Генерируем уникальный ID для изображения
            const imageId = 'img_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            // В реальной реализации здесь должен быть запрос к вашему CDN/серверу
            // Для демонстрации используем imgbb.com API или подобный сервис

            // Временно используем data URL, но с маркером для последующей замены
            const publicUrl = `https://cdn.publikator.demo/${imageId}/${filename}`;

            // Сохраняем маппинг для дальнейшего использования
            imageUrlMap.set(filename, {
                publicUrl: publicUrl,
                dataUrl: dataUrl,
                filename: filename
            });

            return publicUrl;
        }

        // Преобразование data URL в blob URL для лучшей совместимости
        function dataUrlToBlobUrl(dataUrl) {
            const arr = dataUrl.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while(n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            const blob = new Blob([u8arr], {type: mime});
            return URL.createObjectURL(blob);
        }

        // Обработка загрузки текстового файла
        document.getElementById('textFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('textEditor').value = e.target.result;
                };
                reader.readAsText(file, 'utf-8');
            }
        });

        // Обработка загрузки изображений
        document.getElementById('imageFiles').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            const imagesList = document.getElementById('imagesList');

            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedImages.set(file.name, e.target.result);
                    // Генерируем публичный URL для изображения
                    generatePublicImageUrl(file.name, e.target.result);
                    updateImagesList();
                };
                reader.readAsDataURL(file);
            });
        });

        function updateImagesList() {
            const imagesList = document.getElementById('imagesList');
            imagesList.innerHTML = '';

            if (uploadedImages.size > 0) {
                const title = document.createElement('div');
                title.innerHTML = '<strong>Загруженные изображения:</strong>';
                imagesList.appendChild(title);

                uploadedImages.forEach((dataUrl, filename) => {
                    const item = document.createElement('div');
                    item.className = 'image-item';
                    item.innerHTML = `
                        <img src="${dataUrl}" alt="${filename}" />
                        <span>${filename}</span>
                    `;
                    imagesList.appendChild(item);
                });
            }
        }

        function generatePreview() {
            const text = document.getElementById('textEditor').value;
            const previewContent = document.getElementById('previewContent');

            if (!text.trim()) {
                previewContent.innerHTML = '<p style="color: #999;">Пожалуйста, введите текст</p>';
                return;
            }

            let processedText = text;

            // Обработка загруженных изображений [IMG:]
            const imageRegex = /\[IMG:([^\]]+)\]\s*([^
]*)/g;
            processedText = processedText.replace(imageRegex, (match, filename, caption) => {
                const imageData = uploadedImages.get(filename);
                if (imageData) {
                    const captionHtml = caption ? `<figcaption>${caption.trim()}</figcaption>` : '';
                    return `<figure><img src="${imageData}" alt="${caption}" />${captionHtml}</figure>`;
                } else {
                    return `<div style="background: #ffebee; color: #c62828; padding: 10px; border-radius: 5px; margin: 10px 0;">⚠️ Изображение "${filename}" не найдено</div>`;
                }
            });

            // Обработка онлайн изображений [URL:]
            const urlRegex = /\[URL:([^\]]+)\]\s*([^
]*)/g;
            processedText = processedText.replace(urlRegex, (match, imageUrl, caption) => {
                const captionHtml = caption ? `<figcaption>${caption.trim()}</figcaption>` : '';
                const errorDiv = `<div style="display: none; background: #ffebee; color: #c62828; padding: 10px; border-radius: 5px; margin: 10px 0;">⚠️ Не удалось загрузить изображение: ${imageUrl}</div>`;
                return `<figure><img src="${imageUrl}" alt="${caption}" onload="this.style.opacity='1'" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'" style="opacity: 0.5; transition: opacity 0.3s;" />${errorDiv}${captionHtml}</figure>`;
            });

            // Обработка абзацев
            processedText = processedText.split('

').map(paragraph => {
                if (paragraph.trim() && !paragraph.includes('<figure') && !paragraph.includes('<div')) { // Не оборачиваем блоки с figure или предупреждениями в <p>
                    return `<p>${paragraph.trim().replace(/
/g, '<br>')}</p>`;
                }
                return paragraph; // Возвращаем как есть, если это уже HTML-блок или пустая строка
            }).join('
'); // Сохраняем переносы

            previewContent.innerHTML = processedText;
            processedContent = processedText; // Сохраняем обработанный HTML для дальнейшего использования
        }

        // Функция для настройки GitHub
        function setupGitHub() {
            // Создаем модальное окно для настройки
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = '9999';

            const modalContent = document.createElement('div');
            modalContent.style.backgroundColor = 'white';
            modalContent.style.padding = '30px';
            modalContent.style.borderRadius = '10px';
            modalContent.style.width = '500px';
            modalContent.style.maxWidth = '90%';
            modalContent.style.maxHeight = '90%';
            modalContent.style.overflowY = 'auto';

            modalContent.innerHTML = `
                <h2 style="margin-top: 0; color: #4facfe;">Настройка интеграции с GitHub</h2>
                <p>Для загрузки и управления изображениями через GitHub, пожалуйста, заполните следующие поля:</p>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Имя пользователя GitHub:</label>
                    <input type="text" id="github-owner" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" 
                        value="${githubConfig.owner}" placeholder="например, username">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Название репозитория:</label>
                    <input type="text" id="github-repo" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" 
                        value="${githubConfig.repo}" placeholder="например, my-blog-images">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Ветка:</label>
                    <input type="text" id="github-branch" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" 
                        value="${githubConfig.branch}" placeholder="main">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Персональный токен доступа:</label>
                    <input type="password" id="github-token" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" 
                        value="${githubConfig.token}" placeholder="ghp_xxxxxxxxxxxx">
                    <p style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        <a href="https://github.com/settings/tokens" target="_blank" style="color: #4facfe;">Создать токен</a> 
                        с правами доступа к репозиторию (repo).
                    </p>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Путь к папке с изображениями:</label>
                    <input type="text" id="github-images-path" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" 
                        value="${githubConfig.imagesPath}" placeholder="e.g., images/articles/">
                    <p style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        Укажите путь к папке в репозитории (e.g., images/ или my-docs/assets/). <strong>Важно: путь должен заканчиваться на /</strong>
                    </p>
                </div>

                <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                    <button id="github-cancel" style="padding: 10px 15px; margin-right: 10px; border: none; border-radius: 5px; 
                        background-color: #f1f1f1; cursor: pointer;">Отмена</button>
                    <button id="github-save" style="padding: 10px 15px; border: none; border-radius: 5px; 
                        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; cursor: pointer;">Сохранить</button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Обработчики событий
            document.getElementById('github-cancel').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            document.getElementById('github-save').addEventListener('click', () => {
                // Сохраняем настройки
                githubConfig.owner = document.getElementById('github-owner').value.trim();
                githubConfig.repo = document.getElementById('github-repo').value.trim();
                githubConfig.branch = document.getElementById('github-branch').value.trim() || 'main';
                githubConfig.token = document.getElementById('github-token').value.trim();
                githubConfig.imagesPath = document.getElementById('github-images-path').value.trim();

            // Добавляем / в конец пути, если его нет, и проверяем, что это не просто "/"
            if (githubConfig.imagesPath && githubConfig.imagesPath !== '/' && !githubConfig.imagesPath.endsWith('/')) {
                    githubConfig.imagesPath += '/';
                }
            if (githubConfig.imagesPath === '/') { // Prevent using root as imagesPath if accidentally entered
                githubConfig.imagesPath = 'images/'; 
                showNotification('Путь к изображениям не может быть корневым. Установлен путь по умолчанию: images/', 'error');
            }

                // Сохраняем настройки в localStorage
                localStorage.setItem('githubConfig', JSON.stringify({
                    owner: githubConfig.owner,
                    repo: githubConfig.repo,
                    branch: githubConfig.branch,
                    imagesPath: githubConfig.imagesPath
                    // Не сохраняем токен в localStorage по соображениям безопасности
                }));

                document.body.removeChild(modal);

                // Показываем сообщение об успехе и начинаем валидацию
                showNotification('Настройки GitHub сохранены! Проверка конфигурации...', 'info');
                validateGitHubConfig(); 
            });
        }

        // Функция для валидации GitHub конфигурации
        async function validateGitHubConfig(showSuccessNotification = true) { // Added parameter
            const manageImagesBtnContainer = document.getElementById('manageGitHubImagesBtnContainer');

            if (!githubConfig.owner || !githubConfig.repo) {
                if (showSuccessNotification) showNotification('Имя пользователя и репозиторий GitHub должны быть указаны для валидации.', 'error');
                if (manageImagesBtnContainer) manageImagesBtnContainer.style.display = 'none';
                return false; // Added return
            }
            if (!githubConfig.token) {
                if (showSuccessNotification) showNotification('Персональный токен доступа GitHub не указан. Пожалуйста, настройте его.', 'error');
                if (manageImagesBtnContainer) manageImagesBtnContainer.style.display = 'none';
                return false; // Added return
            }

            const loadingIndicator = showLoadingIndicator('Проверка настроек GitHub...');
            let isValid = false; // Added flag
            try {
                const response = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                hideLoadingIndicator(loadingIndicator);

                if (response.ok) { // Status 200-299
                    if (showSuccessNotification) showNotification('Настройки GitHub успешно проверены! Готово к загрузке изображений.', 'success');
                    if (manageImagesBtnContainer) manageImagesBtnContainer.style.display = 'inline-block'; // Show manage button
                    isValid = true;
                } else if (response.status === 401) {
                    if (showSuccessNotification) showNotification('Проверка GitHub провалена: Неверный токен доступа. Проверьте токен.', 'error');
                    if (manageImagesBtnContainer) manageImagesBtnContainer.style.display = 'none';
                } else if (response.status === 403) {
                     if (showSuccessNotification) showNotification('Проверка GitHub провалена: Токен не имеет достаточных прав доступа к репозиторию.', 'error');
                     if (manageImagesBtnContainer) manageImagesBtnContainer.style.display = 'none';
                } else if (response.status === 404) {
                    if (showSuccessNotification) showNotification('Проверка GitHub провалена: Репозиторий не найден. Проверьте имя пользователя и название репозитория.', 'error');
                    if (manageImagesBtnContainer) manageImagesBtnContainer.style.display = 'none';
                } else {
                    if (showSuccessNotification) showNotification(`Проверка GitHub провалена: Ошибка ${response.status}. ${response.statusText}`, 'error');
                    if (manageImagesBtnContainer) manageImagesBtnContainer.style.display = 'none';
                }
            } catch (error) {
                hideLoadingIndicator(loadingIndicator);
                console.error('Ошибка валидации GitHub:', error);
                if (showSuccessNotification) showNotification('Проверка GitHub провалена: Произошла сетевая ошибка или GitHub недоступен.', 'error');
                if (manageImagesBtnContainer) manageImagesBtnContainer.style.display = 'none';
            }
            return isValid; // Return validation status
        }

        let currentArticleIdForManagement = null; // Store article ID for management modal

        // Function to open modal for managing GitHub Images
        function openManageGitHubImagesModal() {
            if (!currentArticleIdForManagement) {
                showNotification("ID статьи не определен. Скопируйте контент с изображениями на GitHub хостинг хоты бы раз.", "error");
                return;
            }

            const articleImages = JSON.parse(localStorage.getItem(`article_${currentArticleIdForManagement}_images`) || '[]');

            const modal = document.createElement('div');
            // Basic styling - can be enhanced
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background-color: rgba(0,0,0,0.6); display: flex; align-items: center;
                justify-content: center; z-index: 10000; padding: 20px;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background-color: white; padding: 25px; border-radius: 10px;
                width: 600px; max-width: 95%; max-height: 80vh; overflow-y: auto;
                box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            `;
            modalContent.setAttribute('role', 'dialog');
            modalContent.setAttribute('aria-labelledby', 'manage-images-title');
            modalContent.setAttribute('aria-modal', 'true');


            modalContent.innerHTML = `
                <h2 id="manage-images-title" style="margin-top: 0; color: #4facfe; margin-bottom:10px;">Управление изображениями для статьи:</h2>
                <p style="font-size:0.9em; color:#555; margin-bottom:20px;">ID статьи: <strong>${currentArticleIdForManagement}</strong></p>
                <div id="githubImagesList" style="margin-bottom: 20px;"></div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                    <button id="github-manage-close" class="btn btn-secondary" style="background: #6c757d;">Закрыть</button>
                    ${articleImages.length > 0 ? `<button id="github-delete-all-article-images" class="btn" style="background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);">Удалить все (${articleImages.length}) с GitHub</button>` : ''}
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => { // Close on backdrop click
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });


            document.getElementById('github-manage-close').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            if (document.getElementById('github-delete-all-article-images')) {
                document.getElementById('github-delete-all-article-images').addEventListener('click', () => {
                    confirmAction(`Вы уверены, что хотите удалить ВСЕ (${articleImages.length}) изображения для статьи ${currentArticleIdForManagement} с GitHub? Это действие нельзя отменить.`, () => {
                        deleteArticleImages(currentArticleIdForManagement).then(() => {
                           if (modal.parentNode) document.body.removeChild(modal); // Close modal on success
                           showNotification(`Все изображения для статьи ${currentArticleIdForManagement} удалены.`, 'success');
                        }).catch(err => {
                           showNotification(`Ошибка при удалении всех изображений: ${err.message}`, 'error');
                        });
                    });
                });
            }
            
            renderGitHubImagesList(currentArticleIdForManagement, modalContent.querySelector('#githubImagesList'));
        }

        function renderGitHubImagesList(articleId, containerElement) {
            const articleImages = JSON.parse(localStorage.getItem(`article_${articleId}_images`) || '[]');
            containerElement.innerHTML = ''; // Clear previous list

            if (articleImages.length === 0) {
                containerElement.innerHTML = '<p style="color: #777; text-align:center;">Нет изображений для этой статьи на GitHub.</p>';
                // Disable delete all button if no images
                const deleteAllBtn = document.getElementById('github-delete-all-article-images');
                if (deleteAllBtn) {
                    deleteAllBtn.disabled = true;
                    deleteAllBtn.style.opacity = '0.6';
                    deleteAllBtn.textContent = 'Удалить все (0) с GitHub';
                }
                return;
            }

            const ul = document.createElement('ul');
            ul.style.cssText = 'list-style: none; padding: 0;';
            articleImages.forEach(image => {
                const li = document.createElement('li');
                li.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;';
                
                const imgPreview = document.createElement('img');
                imgPreview.src = image.url; // Assuming image.url is the raw.githubusercontent URL
                imgPreview.alt = image.filename;
                imgPreview.style.cssText = 'width: 50px; height: 50px; object-fit: cover; border-radius: 4px; margin-right: 15px;';

                const fileNameSpan = document.createElement('span');
                fileNameSpan.textContent = image.filename;
                fileNameSpan.style.flexGrow = '1';
                fileNameSpan.style.fontSize = '0.9em';

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '🗑️';
                deleteBtn.className = 'btn';
                deleteBtn.setAttribute('aria-label', `Удалить изображение ${image.filename} с GitHub`);
                deleteBtn.title = `Удалить ${image.filename} с GitHub`;
                deleteBtn.style.cssText = 'background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%); padding: 5px 10px; font-size: 14px; margin-left:10px;';
                deleteBtn.onclick = () => {
                    confirmAction(`Вы уверены, что хотите удалить "${image.filename}" с GitHub?`, () => {
                        deleteSingleImageFromGitHub(articleId, image.filename, image.sha)
                            .then(() => {
                                showNotification(`Изображение "${image.filename}" удалено с GitHub.`, 'success');
                                renderGitHubImagesList(articleId, containerElement); // Re-render list
                                // Update the "delete all" button text/state as well
                                const deleteAllBtn = document.getElementById('github-delete-all-article-images');
                                const updatedImages = JSON.parse(localStorage.getItem(`article_${articleId}_images`) || '[]');
                                if (deleteAllBtn) {
                                    if (updatedImages.length > 0) {
                                     deleteAllBtn.textContent = `Удалить все (${updatedImages.length}) с GitHub`;
                                     deleteAllBtn.disabled = false;
                                     deleteAllBtn.style.opacity = '1';
                                    } else {
                                     deleteAllBtn.textContent = 'Удалить все (0) с GitHub';
                                     deleteAllBtn.disabled = true;
                                     deleteAllBtn.style.opacity = '0.6';
                                    }
                                }
                            })
                            .catch(err => showNotification(`Ошибка удаления "${image.filename}": ${err.message}`, 'error'));
                    });
                };

                const imageInfoDiv = document.createElement('div');
                imageInfoDiv.style.display = 'flex';
                imageInfoDiv.style.alignItems = 'center';
                imageInfoDiv.appendChild(imgPreview);
                imageInfoDiv.appendChild(fileNameSpan);
                
                li.appendChild(imageInfoDiv);
                li.appendChild(deleteBtn);
                ul.appendChild(li);
            });
            containerElement.appendChild(ul);
        }
        
        async function deleteSingleImageFromGitHub(articleId, filename, sha) {
            if (!githubConfig.owner || !githubConfig.repo || !githubConfig.token) {
                showNotification('Настройки GitHub не сконфигурированы.', 'error');
                throw new Error('GitHub config missing');
            }
            const imagePath = `${githubConfig.imagesPath}${articleId}/${filename}`;
            const response = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${imagePath}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `token ${githubConfig.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `Delete image ${filename} for article ${articleId} via PublikaTor`,
                    sha: sha,
                    branch: githubConfig.branch
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: response.statusText }));
                console.error(`Ошибка удаления изображения ${filename} с GitHub:`, errorData);
                throw new Error(`GitHub API: ${errorData.message || response.status}`);
            }
            
            // Update localStorage
            let articleImages = JSON.parse(localStorage.getItem(`article_${articleId}_images`) || '[]');
            articleImages = articleImages.filter(img => img.filename !== filename);
            localStorage.setItem(`article_${articleId}_images`, JSON.stringify(articleImages));
            
            return await response.json();
        }


        // Функция для загрузки изображения на GitHub
        async function uploadImageToGitHub(dataUrl, filename, articleId) {
            currentArticleIdForManagement = articleId; // Keep track of the latest article ID used with GitHub
            // Проверяем настройки GitHub
            if (!githubConfig.owner || !githubConfig.repo || !githubConfig.token) {
                showNotification('Необходимо настроить интеграцию с GitHub. Нажмите ⚙️ для настройки.', 'error');
                 // Consider calling setupGitHub() here or providing a more direct way to open it.
                showNotification('Необходимо настроить интеграцию с GitHub. Нажмите ⚙️ для настройки.', 'error');
                // Consider calling setupGitHub() here.
                throw new Error('Необходимо настроить интеграцию с GitHub');
            }

            try {
                // Преобразуем dataUrl в base64 для GitHub API
                const base64Data = dataUrl.split(',')[1];

                // Создаем уникальный путь для изображения, включая ID статьи
                const imagePath = `${githubConfig.imagesPath}${articleId}/${filename}`;

                // Получаем SHA файла, если он существует
                let fileSha = null;
                try {
                    const fileResponse = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${imagePath}?ref=${githubConfig.branch}`, {
                        headers: {
                            'Authorization': `token ${githubConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (fileResponse.ok) {
                        const fileData = await fileResponse.json();
                        fileSha = fileData.sha;
                    }
                } catch (error) {
                    // Файл не существует, это нормально
                    console.log('Файл не существует, будет создан новый');
                }

                // Создаем или обновляем файл
                const response = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${imagePath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Upload image ${filename} for article ${articleId}`,
                        content: base64Data,
                        branch: githubConfig.branch,
                        sha: fileSha
                    })
                });

                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();

                // Сохраняем информацию о загруженном изображении
                saveImageInfo(articleId, filename, data.content.sha, data.content.html_url);

                // Возвращаем URL для доступа к изображению через GitHub Pages или raw.githubusercontent.com
                // Используем raw.githubusercontent.com для прямого доступа к изображению
                return `https://raw.githubusercontent.com/${githubConfig.owner}/${githubConfig.repo}/${githubConfig.branch}/${imagePath}`;
            } catch (error) {
                console.error('Ошибка загрузки изображения на GitHub:', error);
                showNotification('Ошибка загрузки изображения на GitHub: ' + error.message, 'error');
                throw error;
            }
        }

        // Функция для сохранения информации о загруженных изображениях
        function saveImageInfo(articleId, filename, sha, url) {
            // Получаем текущий список изображений для статьи
            let articleImages = JSON.parse(localStorage.getItem(`article_${articleId}_images`) || '[]');

            // Добавляем информацию о новом изображении
            articleImages.push({
                filename,
                sha,
                url,
                uploadedAt: new Date().toISOString()
            });

            // Сохраняем обновленный список
            localStorage.setItem(`article_${articleId}_images`, JSON.stringify(articleImages));
        }

        // Функция для удаления всех изображений, связанных со статьей
        async function deleteArticleImages(articleId) { // This function deletes ALL images for an article
            // Проверяем настройки GitHub
            if (!githubConfig.owner || !githubConfig.repo || !githubConfig.token) {
                setupGitHub();
                throw new Error('Необходимо настроить интеграцию с GitHub');
            }

            // Получаем список изображений для статьи
            const articleImages = JSON.parse(localStorage.getItem(`article_${articleId}_images`) || '[]');

            if (articleImages.length === 0) {
                showNotification('Нет изображений для удаления', 'info');
                return;
            }

            // Показываем индикатор загрузки
            const loadingIndicator = showLoadingIndicator('Удаление изображений...');

            try {
                // Удаляем каждое изображение
                for (const image of articleImages) {
                    const imagePath = `${githubConfig.imagesPath}${articleId}/${image.filename}`;

                    // Удаляем файл
                    const response = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${imagePath}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `token ${githubConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Delete image ${image.filename} for article ${articleId}`,
                            sha: image.sha,
                            branch: githubConfig.branch
                        })
                    });

                    if (!response.ok) {
                        console.error(`Ошибка удаления изображения ${image.filename}:`, await response.text());
                    }
                }

                // Очищаем список изображений для статьи
                localStorage.removeItem(`article_${articleId}_images`);

                // Скрываем индикатор загрузки
                hideLoadingIndicator(loadingIndicator);

                // Показываем сообщение об успехе
                showNotification(`Удалено ${articleImages.length} изображений для статьи ${articleId}`, 'success');
            } catch (error) {
                // Скрываем индикатор загрузки
                hideLoadingIndicator(loadingIndicator);

                console.error('Ошибка удаления изображений:', error);
                showNotification('Ошибка удаления изображений: ' + error.message, 'error');
                throw error;
            }
        }

        // Функция для генерации уникального ID статьи
        function generateArticleId() {
            // Генерируем ID на основе заголовка и даты
            const title = document.querySelector('#previewContent h1, #previewContent h2, #previewContent h3, #previewContent p')?.textContent || '';
            const titleSlug = title.toLowerCase()
                .replace(/[^\w\s-]/g, '') // Удаляем специальные символы
                .replace(/\s+/g, '-') // Заменяем пробелы на дефисы
                .substring(0, 30); // Ограничиваем длину

            const timestamp = Date.now().toString(36);
            return `${titleSlug}-${timestamp}`;
        }

        // Вспомогательные функции
        function showNotification(message, type = 'info', duration = 5000, buttons = null) {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `custom-notification ${type}`;
            notification.textContent = message;
            
            // Add ARIA role for alerts
            if (type === 'error' || type === 'success' || type === 'info') {
                 notification.setAttribute('role', 'alert');
            }


            if (buttons) {
                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'notification-buttons';
                buttons.forEach(btnConfig => {
                    const button = document.createElement('button');
                    button.textContent = btnConfig.text;
                    button.className = btnConfig.className;
                    button.onclick = () => {
                        btnConfig.action();
                        if (notification.parentNode === container) { // Check if still in DOM
                           container.removeChild(notification);
                        }
                    };
                    buttonsDiv.appendChild(button);
                });
                notification.appendChild(buttonsDiv);
            }

            container.insertBefore(notification, container.firstChild); // Add to top of container

            if (duration > 0) { // duration 0 or less means sticky
                setTimeout(() => {
                    if (notification.parentNode === container) { // Check if still in DOM
                         container.removeChild(notification);
                    }
                }, duration);
            }
            return notification; // Return for potential manual removal
        }

        // Confirmation Dialog using showNotification
        function confirmAction(message, onConfirm, onCancel = () => {}) {
            showNotification(message, 'confirm', 0, [ // Sticky notification (duration 0)
                { text: 'Да', className: 'confirm-yes', action: onConfirm },
                { text: 'Отмена', className: 'confirm-cancel', action: onCancel }
            ]);
        }

        function showLoadingIndicator(message) {
            const loadingIndicator = document.createElement('div');
            loadingIndicator.style.position = 'fixed';
            loadingIndicator.style.top = '0';
            loadingIndicator.style.left = '0';
            loadingIndicator.style.width = '100%';
            loadingIndicator.style.height = '100%';
            loadingIndicator.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            loadingIndicator.style.display = 'flex';
            loadingIndicator.style.alignItems = 'center';
            loadingIndicator.style.justifyContent = 'center';
            loadingIndicator.style.zIndex = '9999';

            loadingIndicator.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <div class="spinner" style="border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
                    <p>${message}</p>
                </div>
            `;

            document.body.appendChild(loadingIndicator);
            return loadingIndicator;
        }

        function hideLoadingIndicator(loadingIndicator) {
            if (loadingIndicator && loadingIndicator.parentNode) {
                loadingIndicator.parentNode.removeChild(loadingIndicator);
            }
        }

        // Функция для модификации copyForZen с использованием GitHub
        async function copyForZenWithGitHub() {
            if (!processedContent) {
                // Если нет обработанного контента, пытаемся его сгенерировать
                generatePreview();
                if (!processedContent) { // Если и после этого нет, то выходим
                    showNotification('Сначала создайте предварительный просмотр!', 'error');
                    return;
                }
            }

            // Генерируем ID статьи
            const articleId = generateArticleId();

            // Показываем индикатор загрузки
            const loadingIndicator = showLoadingIndicator('Подготовка изображений для Дзена...');

            // Создаем временный div для работы с DOM
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = processedContent; // Берем HTML из предпросмотра

            // Массив для хранения промисов загрузки изображений
            const uploadPromises = [];

            // Находим все <figure> элементы в tempDiv
            const figureElements = tempDiv.querySelectorAll('figure');

            for (const figure of figureElements) {
                const imgElement = figure.querySelector('img');
                const figcaptionElement = figure.querySelector('figcaption');
                const caption = figcaptionElement ? figcaptionElement.textContent : '';

                if (!imgElement) continue; // Пропускаем, если нет img

                const originalSrc = imgElement.getAttribute('src');
                const isLocalImage = originalSrc.startsWith('data:image');
                const isOnlineImage = originalSrc.startsWith('http');

                if (isLocalImage) {
                    // Находим имя файла по dataUrl
                    let filename = null;
                    for (const [key, value] of uploadedImages.entries()) {
                        if (value === originalSrc) {
                            filename = key;
                            break;
                        }
                    }

                    if (filename) {
                        // Создаем промис для загрузки изображения на GitHub
                        const uploadPromise = uploadImageToGitHub(originalSrc, filename, articleId)
                            .then(publicUrl => {
                                // Заменяем src на публичный URL
                                imgElement.src = publicUrl;

                                // Добавляем атрибуты как в Google Docs
                                imgElement.setAttribute('width', '100%');
                                imgElement.setAttribute('height', 'auto');
                                imgElement.setAttribute('data-original-src', filename);
                                imgElement.setAttribute('data-article-id', articleId);

                                // Удаляем лишние атрибуты
                                imgElement.removeAttribute('style');
                                imgElement.removeAttribute('onload');
                                imgElement.removeAttribute('onerror');
                            })
                            .catch(error => {
                                console.error('Ошибка загрузки изображения:', error);
                                // В случае ошибки оставляем dataUrl
                            });

                        uploadPromises.push(uploadPromise);
                    }
                } else if (isOnlineImage) {
                    // Добавляем атрибуты как в Google Docs
                    imgElement.setAttribute('width', '100%');
                    imgElement.setAttribute('height', 'auto');
                    imgElement.setAttribute('data-original-src', originalSrc);
                    imgElement.setAttribute('data-article-id', articleId);

                    // Удаляем лишние атрибуты
                    imgElement.removeAttribute('style');
                    imgElement.removeAttribute('onload');
                    imgElement.removeAttribute('onerror');

                    // Удаляем div с ошибкой загрузки, если он есть
                    const errorDiv = imgElement.nextElementSibling;
                    if (errorDiv && errorDiv.tagName === 'DIV' && errorDiv.style.display === 'none') {
                        errorDiv.remove();
                    }
                }
            }

            // Ждем завершения всех загрузок
            Promise.all(uploadPromises)
                .then(() => {
                    // Получаем обновленный HTML
                    let zenHtml = tempDiv.innerHTML;

                    // Очищаем HTML от специфичных стилей и атрибутов, которые Дзен может не понять
                    // Но сохраняем важные атрибуты для изображений и структуру figure/figcaption
                    zenHtml = zenHtml.replace(/style="[^"]*"/g, function(match) {
                        // Сохраняем стили для подписей и контейнеров изображений
                        if (match.includes('text-align') || match.includes('font-style') || 
                            match.includes('color') || match.includes('font-size')) {
                            return match;
                        }
                        return '';
                    });

                    zenHtml = zenHtml.replace(/onload="[^"]*"/g, '');
                    zenHtml = zenHtml.replace(/onerror="[^"]*"/g, '');
                    zenHtml = zenHtml.replace(/<div style="display: none; background:[^>]+>.*?<\/div>/g, '');

                    // Убираем лишние переносы и пробелы
                    zenHtml = zenHtml.replace(/
\s*
/g, '
');
                    zenHtml = zenHtml.trim();

                    // Копирование в буфер обмена
                    copyHtmlToClipboard(zenHtml);

                    // Удаляем индикатор загрузки
                    hideLoadingIndicator(loadingIndicator);

                    // Показываем сообщение об успехе
                    showNotification(`Контент скопирован для Дзена! ID статьи: ${articleId}`, 'success');

                    // Добавляем кнопку для удаления изображений
                    addDeleteImagesButton(articleId);
                })
                .catch(error => {
                    console.error('Ошибка при обработке изображений:', error);
                    hideLoadingIndicator(loadingIndicator);
                    showNotification('Произошла ошибка при подготовке изображений. Пожалуйста, попробуйте еще раз.', 'error');
                });
        }

        // Функция для добавления кнопки удаления изображений
        function addDeleteImagesButton(articleId) {
            // Проверяем, есть ли уже кнопка удаления
            if (document.getElementById(`delete-images-${articleId}`)) {
                return;
            }

            // Создаем кнопку
            const deleteButton = document.createElement('button');
            deleteButton.id = `delete-images-${articleId}`;
            deleteButton.className = 'btn';
            deleteButton.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%)';
            deleteButton.style.marginLeft = '10px';
            deleteButton.innerHTML = '🗑️ Удалить изображения статьи';
            deleteButton.title = `Удалить все изображения для статьи ${articleId}`;

            // Добавляем обработчик события
            deleteButton.addEventListener('click', () => {
                confirmAction(`Вы уверены, что хотите удалить все изображения для статьи ${articleId}? Это действие нельзя отменить.`, () => {
                    deleteArticleImages(articleId)
                        .then(() => {
                            if (deleteButton.parentNode) {
                                deleteButton.parentNode.removeChild(deleteButton);
                            }
                    // Also, if the management modal is open and for this article, refresh it or close it
                    const modal = document.querySelector('div[style*="z-index: 10000"]'); // Quick check if modal is open
                    if (modal && currentArticleIdForManagement === articleId) {
                        const listContainer = modal.querySelector('#githubImagesList');
                        if (listContainer) renderGitHubImagesList(articleId, listContainer);
                    }
                        });
                });
            });

            // Добавляем кнопку рядом с кнопкой копирования для Дзена
            const zenCopyBtn = document.getElementById('zenCopyBtn');
            if (zenCopyBtn) {
                zenCopyBtn.parentNode.appendChild(deleteButton);
            } else {
                const zenCopyBtn2 = document.getElementById('zenCopyBtn2');
                if (zenCopyBtn2) {
                    zenCopyBtn2.parentNode.appendChild(deleteButton);
                }
            }
        }

        // Функция для загрузки изображения на внешний хостинг (для совместимости)
        async function uploadImageToExternalHost(dataUrl, filename) {
            // В реальной реализации здесь должен быть код для загрузки изображения на сервис хостинга
            // Для интеграции с GitHub используем uploadImageToGitHub

            try {
                // Генерируем ID статьи
                const articleId = generateArticleId();

                // Загружаем изображение на GitHub
                return await uploadImageToGitHub(dataUrl, filename, articleId);
            } catch (error) {
                console.error('Ошибка загрузки изображения:', error);

                // В случае ошибки возвращаем демо-URL (для тестирования)
                return `https://cdn.publikator.demo/img_${Date.now()}_${Math.random().toString(36).substr(2, 9)}/${filename}`;
            }
        }

        // Вспомогательная функция для преобразования dataURL в Blob
        function dataURLtoBlob(dataURL) {
            return new Promise((resolve) => {
                const arr = dataURL.split(',');
                const mime = arr[0].match(/:(.*?);/)[1];
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);
                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n);
                }
                resolve(new Blob([u8arr], { type: mime }));
            });
        }

        // Функция для копирования HTML в буфер обмена
        function copyHtmlToClipboard(html) {
            // Создаем временный div для копирования
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.innerHTML = html;
            document.body.appendChild(tempDiv);

            try {
                // Пытаемся использовать современный Clipboard API
                if (navigator.clipboard && navigator.clipboard.write) {
                    const clipboardItem = new ClipboardItem({
                        'text/html': new Blob([html], { type: 'text/html' }),
                        'text/plain': new Blob([tempDiv.textContent || tempDiv.innerText || ''], { type: 'text/plain' })
                    });

                    navigator.clipboard.write([clipboardItem])
                        .catch(err => {
                            console.error('Ошибка Clipboard API:', err);
                            fallbackCopyMethod(tempDiv);
                        });
                } else {
                    // Используем fallback метод
                    fallbackCopyMethod(tempDiv);
                }
            } catch (err) {
                console.error('Ошибка копирования:', err);
                fallbackCopyMethod(tempDiv);
            } finally {
                // Удаляем временный div
                if (tempDiv.parentNode) {
                    tempDiv.parentNode.removeChild(tempDiv);
                }
            }
        }

        // Fallback метод копирования
        function fallbackCopyMethod(element) {
            const range = document.createRange();
            range.selectNodeContents(element);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            let successful = false;
            try {
                successful = document.execCommand('copy');
                if (!successful) {
                   showNotification('Не удалось скопировать контент через execCommand. Попробуйте вручную (Ctrl+C).', 'error');
                } else {
                   showNotification('Контент скопирован (fallback метод).', 'success');
                }
            } catch (err) {
                console.error('Ошибка fallback копирования:', err);
                showNotification('Ошибка при fallback копировании. Пожалуйста, скопируйте вручную (Ctrl+C).', 'error');
            }

            // Очищаем выделение
            if (window.getSelection) {
                window.getSelection().removeAllRanges();
            }
        }

        // Функция для отображения сообщения об успешном копировании
        function showCopySuccess() {
            const successDiv = document.getElementById('copySuccess');
            if (successDiv) {
                successDiv.style.display = 'block';

                // Изменяем стиль кнопки
                const btn = document.getElementById('zenCopyBtn') || document.getElementById('zenCopyBtn2');
                if (btn) {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '✅ Скопировано для Дзена!';
                    btn.style.background = '#28a745';

                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = '';
                        successDiv.style.display = 'none';
                    }, 3000);
                }
            }
        }

        function publishContent() {
            if (!processedContent) {
                generatePreview();
                if (!processedContent) {
                    showNotification('Сначала создайте предварительный просмотр!', 'error');
                    return;
                }
            }

            const loading = document.getElementById('loading');
            const publishResult = document.getElementById('publishResult');
            const publishedContentDiv = document.getElementById('publishedContent');
            const finalContentDiv = document.getElementById('finalContent');

            loading.style.display = 'block';
            publishResult.innerHTML = '';

            setTimeout(() => {
                finalContentDiv.innerHTML = processedContent;
                publishedContentDiv.style.display = 'block';

                window.publishedHtml = createFullHtmlPage(processedContent);

                loading.style.display = 'none';
                publishResult.innerHTML = `
                    <div class="publish-url">
                        <strong>✅ Контент успешно опубликован!</strong><br><br>
                        <p style="color: rgba(255,255,255,0.9);">Ваша страница отображается ниже и готова для использования</p>
                    </div>
                `;

                setTimeout(() => {
                    publishedContentDiv.scrollIntoView({ behavior: 'smooth' });
                }, 500);
            }, 1500);
        }

        function downloadCurrentPage() {
            const htmlContent = window.publishedHtml;
            if (htmlContent) {
                const pageId = 'page_' + Date.now();
                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `published_page_${pageId}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } else {
                showNotification('Сначала опубликуйте контент!', 'error');
            }
        }

        function createFullHtmlPage(content) {
            return `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Опубликованная страница</title>
    <style>
        body { font-family: 'Times New Roman', Times, serif; margin: 20px auto; max-width: 800px; padding: 0 20px; line-height: 1.6; color: #333; }
        figure { margin: 20px 0; text-align: center; }
        img { max-width: 100%; height: auto; display: block; margin: 0 auto; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        p { margin: 1em 0; }
        figcaption { font-style: italic; color: #555; text-align: center; margin-top: 8px; font-size: 0.9em; }
        /* Стили для блоков предупреждений, если они попадут в финальный HTML */
        div[style*="background: #ffebee"] { border: 1px solid #c62828; padding: 10px; margin: 10px 0; border-radius: 4px; }
    </style>
</head>
<body>
    ${content}
</body>
</html>`;
        }

        function clearAll() {
            confirmAction("Вы уверены, что хотите все очистить? Это действие нельзя отменить.", () => {
                document.getElementById('textEditor').value = '';
                document.getElementById('previewContent').innerHTML = '<p style="text-align: center; color: #999; font-style: italic;">Загрузите текст и изображения, затем нажмите "Предварительный просмотр"</p>';
                document.getElementById('imagesList').innerHTML = '';
                const publishResult = document.getElementById('publishResult');
                if(publishResult) publishResult.innerHTML = '';
                const publishedContent = document.getElementById('publishedContent');
                if(publishedContent) publishedContent.style.display = 'none';

                uploadedImages.clear();
                imageUrlMap.clear();
                processedContent = '';
                window.publishedHtml = '';

                // Удаляем кнопки удаления изображений
                const deleteButtons = document.querySelectorAll('button[id^="delete-images-"]');
                deleteButtons.forEach(btn => btn.remove());
                showNotification('Все поля очищены.', 'info', 2000);
            });
        }

        function copyToClipboard() {
             if (window.publishedHtml) {
                navigator.clipboard.writeText(window.publishedHtml).then(() => {
                    showNotification('HTML код полной страницы скопирован в буфер обмена!', 'success');
                }).catch(err => {
                    showNotification('Ошибка копирования HTML: ' + err, 'error');
                    console.error('Ошибка копирования HTML:', err);
                });
            } else {
                showNotification('Сначала опубликуйте контент, чтобы получить HTML для копирования.', 'error');
            }
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Загружаем сохраненные настройки GitHub (без токена)
            const savedConfig = JSON.parse(localStorage.getItem('githubConfig') || '{}');
            if (savedConfig.owner) githubConfig.owner = savedConfig.owner;
            if (savedConfig.repo) githubConfig.repo = savedConfig.repo;
            if (savedConfig.branch) githubConfig.branch = savedConfig.branch;
            if (savedConfig.imagesPath) githubConfig.imagesPath = savedConfig.imagesPath;
            
            // Важно: Токен НЕ загружается из localStorage. Пользователь должен будет его ввести при необходимости.
            // Однако, если есть owner и repo, можно попытаться валидировать, если токен уже есть в githubConfig (например, из предыдущего сеанса в той же вкладке)
            // Но лучше всего, если пользователь явно инициирует настройку/проверку, если токен отсутствует.
            // For now, validateGitHubConfig(false) could be called to silently check and show manage button if config is valid and token happens to be there.
            // validateGitHubConfig(false); // Silently check and update UI if possible.

            // Добавляем кнопку настройки GitHub в интерфейс
            const fileUploadSection = document.querySelector('.file-upload');
            if (fileUploadSection) {
                const setupButton = document.createElement('div');
                setupButton.className = 'file-input-wrapper';
                setupButton.style.background = 'linear-gradient(135deg, #333 0%, #666 100%)';
                setupButton.innerHTML = '⚙️ Настройка GitHub';
                setupButton.style.cursor = 'pointer';
                setupButton.addEventListener('click', setupGitHub);
                fileUploadSection.appendChild(setupButton);
            }
        });
    </script>
</body>
</html>
